___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "displayName": "Qualaroo",
  "description": "This tag enables you to run Qualaroo Nudges on your website.\n\n○ Automatically works for both http and https pages.\n○ Asynchronous loading so it won\u0027t slow down your site.",
  "categories": ["SURVEY", "EXPERIMENTATION", "LEAD_GENERATION"],
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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",
    "displayName": "",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "notSetText": "Required field to make Qualaroo work.",
    "displayName": "Qualaroo Install Link",
    "simpleValueType": true,
    "name": "jsUrl",
    "type": "TEXT",
    "valueHint": "e.g. https://cl.qualaroo.com/ki.js/ID/UID.js",
    "lineCount": 2
  },
  {
    "simpleValueType": true,
    "name": "identity",
    "checkboxText": "Identify your nudge respondents",
    "type": "CHECKBOX",
    "subParams": [
      {
        "displayName": "Get your's user's identity attribute by:",
        "simpleValueType": true,
        "name": "identifier",
        "type": "RADIO",
        "radioItems": [
          {
            "displayValue": "by data layer variable",
            "help": "Data Layer Variable being accessed",
            "value": "fromDataLayer",
            "subParams": [
              {
                "notSetText": "qualaroo.*",
                "displayName": "",
                "simpleValueType": true,
                "name": "dataLayerVariable",
                "type": "TEXT",
                "valueHint": "qualaroo.*"
              }
            ]
          }
        ],
        "subParams": []
      }
    ]
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.qualaroo.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "qualaroo.*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_kiq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const logToConsole = require('logToConsole');
const queryPermission = require('queryPermission');
const injectScript = require('injectScript');
const copyFromDataLayer = require('copyFromDataLayer');
const createQueue = require('createQueue');

const kiq_permission = queryPermission('access_globals', 'readwrite', '_kiq');
const _kiq = kiq_permission ? createQueue('_kiq') : [];

const identifyUsers = () => {
  if (data.identity && data.identifier === 'fromDataLayer') {
    const permission = queryPermission('read_data_layer', data.dataLayerVariable);
    const identifier = copyFromDataLayer(data.dataLayerVariable);

    if (permission && identifier) {
      if (kiq_permission) {
        _kiq({'identify': identifier});
      } else {
        _kiq.push(['identify', identifier]);
      }
    }
  }
};

const onSuccess = () => {
  logToConsole('Qualaroo: Script loaded successfully.');
  identifyUsers();
  data.gtmOnSuccess();
};

const onFailure = () => {
  logToConsole('Qualaroo: Script load failed.');
  data.gtmOnFailure();
};

if (queryPermission('inject_script', data.jsUrl)) {
  injectScript(data.jsUrl, onSuccess, onFailure);
} else {
  logToConsole('Qualaroo: Script load failed due to permissions mismatch.');
  data.gtmOnFailure();
}


___NOTES___

Created on 23.08.2019, 11:44:10
